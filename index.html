/* ================= OS DETECTION ================= */
const isWindows = /Win/i.test(navigator.userAgent);
if (isWindows && window.windowsNotice) {
  windowsNotice.style.display = "block";
}

/* ================= PANEL ================= */
function togglePanel() {
  panel.style.display = panel.style.display === "block" ? "none" : "block";
}
function toggleDark() {
  document.body.classList.toggle("dark");
}

/* ================= INFO POPUPS ================= */
function showInfo() {
  alert(
    "This is a SCHOOL DEMO showing how browser notifications can be abused.\n\nNo real hacking happens."
  );
}
function showWhy() {
  alert(
    "Reasons you may not get notifications:\n\n• Permission not allowed\n• Browser blocked them\n• Windows uses visual previews only\n• GitHub Pages restrictions"
  );
}

/* ================= TOAST (WINDOWS PREVIEW) ================= */
function toast(title, body) {
  const t = document.createElement("div");
  t.className = "toast";
  t.innerHTML = `<strong>${title}</strong><div>${body}</div>`;
  toastArea.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

/* ================= SEND NOTIFICATION ================= */
function send(title, body) {
  if (isWindows) {
    toast(title, body);
  } else if (Notification.permission === "granted") {
    new Notification(title, { body });
  }
}

/* ================= BASIC ACTIONS ================= */
function requestPermission() {
  Notification.requestPermission();
}

function sendOne() {
  send("Notification Demo", msgInput.value || "Test notification");
}

/* ================= FAKE HACK DEMO ================= */
let timers = [];

const messages = [
  "New login detected",
  "Suspicious activity found",
  "Multiple failed password attempts",
  "Accessing private files",
  "Encrypting user data",
  "System takeover in progress"
];

const ips = [
  "185.23.11.42",
  "91.204.16.8",
  "45.133.192.77",
  "203.0.113.5"
];

const locations = [
  "Moscow, RU",
  "Beijing, CN",
  "Berlin, DE",
  "Unknown location"
];

function startDemo() {
  stopAll();
  status.textContent = "Attack in progress...";
  bar.style.width = "0%";

  messages.forEach((msg, i) => {
    const t = setTimeout(() => {
      const ip = ips[i % ips.length];
      const loc = locations[i % locations.length];

      send(
        "SECURITY ALERT",
        `${msg}\nIP: ${ip}\nLocation: ${loc}`
      );

      bar.style.width = ((i + 1) / messages.length) * 100 + "%";

      if (i === messages.length - 1) {
        showLockout();
      }
    }, i * 1200);

    timers.push(t);
  });
}

/* ================= LOCKOUT SCREEN ================= */
function showLockout() {
  const lock = document.getElementById("lockout");
  const cd = document.getElementById("countdown");

  let seconds = 10;
  lock.style.display = "flex";
  cd.textContent = seconds;

  const interval = setInterval(() => {
    seconds--;
    cd.textContent = seconds;
    if (seconds <= 0) clearInterval(interval);
  }, 1000);
}

/* ================= STOP ================= */
function stopAll() {
  timers.forEach(t => clearTimeout(t));
  timers = [];
  bar.style.width = "0%";
  status.textContent = "Stopped";

  const lock = document.getElementById("lockout");
  if (lock) lock.style.display = "none";
}
