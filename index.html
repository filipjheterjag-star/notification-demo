<script>
/* =========================
   ENVIRONMENT DETECTION
========================= */
const isWindows = /Win/i.test(navigator.userAgent);
const isGithub = location.hostname.includes("github.io");

/* =========================
   STATE
========================= */
let sentCountValue = 0;
let spamTimers = [];

/* =========================
   SAFE ELEMENT LOOKUPS
========================= */
const sentCountEl = document.getElementById("sentCount");
const statFillEl  = document.getElementById("statFill");
const historyEl   = document.getElementById("history");
const barEl       = document.getElementById("bar");
const toastArea   = document.getElementById("toastArea");

/* =========================
   CORE FIX — SINGLE PIPELINE
========================= */
function sendNotification(title, body){
  // 1️⃣ increment stats FIRST (always)
  sentCountValue++;
  if(sentCountEl) sentCountEl.textContent = sentCountValue;
  if(statFillEl)  statFillEl.style.width = Math.min(sentCountValue,100) + "%";
  if(barEl)       barEl.style.width = Math.min(sentCountValue,100) + "%";

  // 2️⃣ history
  if(historyEl){
    if(historyEl.textContent.includes("No notifications"))
      historyEl.innerHTML = "";
    historyEl.innerHTML += "• " + body + "<br>";
  }

  // 3️⃣ show notification (real or fake)
  if(isWindows || isGithub){
    showToast(title, body);
  } else {
    try {
      new Notification(title, { body });
    } catch {
      showToast(title, body);
    }
  }
}

/* =========================
   VISUAL TOAST (WINDOWS)
========================= */
function showToast(title, body){
  if(!toastArea) return;
  const t = document.createElement("div");
  t.className = "toast";
  t.innerHTML = `<strong>${title}</strong><div>${body}</div>`;
  toastArea.appendChild(t);
  setTimeout(()=>t.remove(), 3000);
}

/* =========================
   BUTTON ACTIONS (UI SAFE)
========================= */
function sendOne(){
  const t = document.getElementById("titleInput")?.value || "Demo";
  const b = document.getElementById("msgInput")?.value || "Hello";
  sendNotification(t, b);
}

function startDemo(){
  stopAll();
  const speed = +document.getElementById("speed")?.value || 200;
  const count = +document.getElementById("count")?.value || 30;

  for(let i=1;i<=count;i++){
    const id = setTimeout(()=>{
      sendNotification(
        "SECURITY ALERT",
        document.getElementById("msgInput")?.value || "Unusual activity detected"
      );
      if(barEl) barEl.style.width = (i/count*100) + "%";
    }, i * speed);
    spamTimers.push(id);
  }
}

function stopAll(){
  while(spamTimers.length)
    clearTimeout(spamTimers.pop());
}

/* =========================
   PERMISSION (UNCHANGED)
========================= */
function requestPermission(){
  if("Notification" in window)
    Notification.requestPermission();
}
</script>
