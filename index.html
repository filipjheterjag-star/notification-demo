<script>
/* ================= OS DETECT ================= */
const isWindows = /Win/i.test(navigator.userAgent);
if (isWindows && window.windowsNotice) {
  windowsNotice.style.display = "block";
}

/* ================= STATE ================= */
let currentUser = null;
let speed = 200;
let count = 30;
let timeouts = [];

/* ================= SIDEBARS ================= */
function toggleLeft() {
  leftBar.classList.toggle("open");
}
function toggleRight() {
  rightBar.classList.toggle("open");
}
function toggleDark() {
  document.body.classList.toggle("dark");
}

/* ================= USERS ================= */
function loadUsers() {
  return JSON.parse(localStorage.getItem("users") || "{}");
}
function saveUsers(users) {
  localStorage.setItem("users", JSON.stringify(users));
}

function login() {
  const u = username.value.trim();
  const p = password.value;
  if (!u || !p) return alert("Enter both fields");

  const users = loadUsers();
  if (!users[u]) users[u] = { password: p, sent: 0 };
  if (users[u].password !== p) return alert("Wrong password");

  currentUser = u;
  saveUsers(users);
  updateUI();
}

function logout() {
  currentUser = null;
  updateUI();
}

function updateUI() {
  if (currentUser) {
    loginBox.style.display = "none";
    userBox.style.display = "block";
    userLabel.textContent = "Logged in as " + currentUser;
    updateStats();
  } else {
    loginBox.style.display = "block";
    userBox.style.display = "none";
  }
}

function updateStats() {
  if (!currentUser) return;
  const users = loadUsers();
  const sent = users[currentUser]?.sent || 0;
  sentCount.textContent = sent;
  statFill.style.width = Math.min(sent, 100) + "%";
}

function incrementStat() {
  if (!currentUser) return;
  const users = loadUsers();
  users[currentUser].sent = (users[currentUser].sent || 0) + 1;
  saveUsers(users);
  updateStats();
}

/* ================= CONTROLS ================= */
speed.oninput = () => {
  speed = +speed.value;
  speedVal.textContent = speed;
};
count.oninput = () => {
  count = +count.value;
  countVal.textContent = count;
};

/* ================= HISTORY ================= */
function log(msg) {
  if (history.textContent.includes("No notifications")) {
    history.innerHTML = "";
  }
  history.innerHTML += "â€¢ " + msg + "<br>";
}

/* ================= NOTIFICATIONS ================= */
function toast(title, body) {
  const t = document.createElement("div");
  t.className = "toast";
  t.innerHTML = `<strong>${title}</strong><div>${body}</div>`;
  toastArea.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

function sendNotification(title, body) {
  if (isWindows) {
    toast(title, body);
  } else if (Notification.permission === "granted") {
    new Notification(title, { body });
  }
}

/* ================= ACTIONS ================= */
function requestPermission() {
  Notification.requestPermission();
}

function sendOne() {
  const t = titleInput.value || "Demo";
  const m = msgInput.value || "Hello";

  sendNotification(t, m);
  log(m);
  incrementStat();
}

function startDemo() {
  stopAll();
  bar.style.width = "0%";

  for (let i = 1; i <= count; i++) {
    const id = setTimeout(() => {
      sendNotification("SECURITY ALERT", msgInput.value || "Alert");
      bar.style.width = (i / count) * 100 + "%";
      log("SECURITY ALERT");
      incrementStat();
    }, i * speed);

    timeouts.push(id);
  }
}

function stopAll() {
  while (timeouts.length) {
    clearTimeout(timeouts.pop());
  }
}
</script>
