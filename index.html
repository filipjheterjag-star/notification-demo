<script>
document.addEventListener("DOMContentLoaded", () => {

/* =========================
   ENV
========================= */
const isWindows = /Win/i.test(navigator.userAgent);
const isGithub = location.hostname.includes("github.io");

const windowsNotice = document.getElementById("windowsNotice");
if (isWindows && windowsNotice) windowsNotice.style.display = "block";

/* =========================
   ELEMENTS
========================= */
const leftBar   = document.getElementById("leftBar");
const rightBar  = document.getElementById("rightBar");
const loginBox  = document.getElementById("loginBox");
const userBox   = document.getElementById("userBox");
const userLabel = document.getElementById("userLabel");
const sentCount = document.getElementById("sentCount");
const statFill  = document.getElementById("statFill");
const historyEl = document.getElementById("history");
const bar       = document.getElementById("bar");
const toastArea = document.getElementById("toastArea");

const titleInput = document.getElementById("titleInput");
const msgInput   = document.getElementById("msgInput");

const speedSlider = document.getElementById("speed");
const countSlider = document.getElementById("count");
const speedVal    = document.getElementById("speedVal");
const countVal    = document.getElementById("countVal");

const username = document.getElementById("username");
const password = document.getElementById("password");

/* =========================
   STATE
========================= */
let currentUser = null;
let speed = 200;
let count = 30;
const timeouts = [];

/* =========================
   SIDEBARS
========================= */
window.toggleLeft  = () => leftBar?.classList.toggle("open");
window.toggleRight = () => rightBar?.classList.toggle("open");
window.toggleDark  = () => document.body.classList.toggle("dark");

/* =========================
   USERS
========================= */
function loadUsers(){
  try { return JSON.parse(localStorage.getItem("users")) || {}; }
  catch { return {}; }
}

function saveUsers(users){
  try { localStorage.setItem("users", JSON.stringify(users)); }
  catch {}
}

window.login = () => {
  const u = username.value.trim();
  const p = password.value;
  if (!u || !p) return alert("Enter both fields");

  const users = loadUsers();
  if (!users[u]) users[u] = { password: p, sent: 0 };
  if (users[u].password !== p) return alert("Wrong password");

  currentUser = u;
  saveUsers(users);
  updateUI();
};

window.logout = () => {
  currentUser = null;
  updateUI();
};

function updateUI(){
  if (currentUser) {
    loginBox.style.display = "none";
    userBox.style.display = "block";
    userLabel.textContent = "Logged in as " + currentUser;
    updateStats();
  } else {
    loginBox.style.display = "block";
    userBox.style.display = "none";
  }
}

function updateStats(){
  if (!currentUser) return;
  const users = loadUsers();
  const sent = users[currentUser]?.sent || 0;
  sentCount.textContent = sent;
  statFill.style.width = Math.min(sent, 100) + "%";
}

function incrementStat(){
  if (!currentUser) return;
  const users = loadUsers();
  users[currentUser].sent++;
  saveUsers(users);
  updateStats();
}

/* =========================
   CONTROLS
========================= */
if (speedSlider) {
  speedSlider.oninput = () => {
    speed = +speedSlider.value;
    speedVal.textContent = speed;
  };
}

if (countSlider) {
  countSlider.oninput = () => {
    count = +countSlider.value;
    countVal.textContent = count;
  };
}

/* =========================
   HISTORY
========================= */
function log(msg){
  if (historyEl.textContent.includes("No notifications"))
    historyEl.innerHTML = "";
  historyEl.innerHTML += "â€¢ " + msg + "<br>";
}

/* =========================
   NOTIFICATIONS (FIXED)
========================= */
function toast(title, body){
  const d = document.createElement("div");
  d.className = "toast";
  d.innerHTML = `<strong>${title}</strong><div>${body}</div>`;
  toastArea.appendChild(d);
  setTimeout(() => d.remove(), 3000);
}

/* ðŸ”‘ SINGLE PIPELINE */
function send(title, body){
  incrementStat();

  if (isWindows || isGithub) {
    toast(title, body);
  } else {
    try {
      new Notification(title, { body });
    } catch {
      toast(title, body);
    }
  }
}

/* =========================
   ACTIONS (EXPOSED)
========================= */
window.requestPermission = () => {
  if ("Notification" in window)
    Notification.requestPermission();
};

window.sendOne = () => {
  send(titleInput.value || "Demo",
       msgInput.value || "Hello");
  log(msgInput.value || "Hello");
};

window.startDemo = () => {
  stopAll();
  bar.style.width = "0%";

  for (let i = 1; i <= count; i++) {
    const t = setTimeout(() => {
      send("SECURITY ALERT",
           msgInput.value || "Alert");
      bar.style.width = (i / count * 100) + "%";
      log("SECURITY ALERT");
    }, i * speed);
    timeouts.push(t);
  }
};

window.stopAll = () => {
  while (timeouts.length)
    clearTimeout(timeouts.pop());
};

});
</script>
