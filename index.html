<script>
/* =========================
   ENV
========================= */
const isWindows = /Win/i.test(navigator.userAgent);
if (isWindows) windowsNotice.style.display = "block";

/* =========================
   STATE
========================= */
let currentUser = null;
let speed = 200;
let count = 30;
const timeouts = [];

/* =========================
   SIDEBARS
========================= */
function toggleLeft(){ leftBar.classList.toggle("open"); }
function toggleRight(){ rightBar.classList.toggle("open"); }
function toggleDark(){ document.body.classList.toggle("dark"); }

/* =========================
   USERS
========================= */
function loadUsers(){
  try {
    return JSON.parse(localStorage.getItem("users")) || {};
  } catch {
    return {};
  }
}

function saveUsers(users){
  try {
    localStorage.setItem("users", JSON.stringify(users));
  } catch {}
}

function login(){
  const u = username.value.trim();
  const p = password.value;
  if (!u || !p) return alert("Enter both fields");

  const users = loadUsers();
  if (!users[u]) users[u] = { password: p, sent: 0 };
  if (users[u].password !== p) return alert("Wrong password");

  currentUser = u;
  saveUsers(users);
  updateUI();
}

function logout(){
  currentUser = null;
  updateUI();
}

function updateUI(){
  if (currentUser) {
    loginBox.style.display = "none";
    userBox.style.display = "block";
    userLabel.textContent = "Logged in as " + currentUser;
    updateStats();
  } else {
    loginBox.style.display = "block";
    userBox.style.display = "none";
  }
}

function updateStats(){
  if (!currentUser) return;
  const users = loadUsers();
  const sent = users[currentUser]?.sent || 0;
  sentCount.textContent = sent;
  statFill.style.width = Math.min(sent, 100) + "%";
}

function incrementStat(){
  if (!currentUser) return;
  const users = loadUsers();
  users[currentUser].sent++;
  saveUsers(users);
  updateStats();
}

/* =========================
   CONTROLS
========================= */
speed.oninput = () => {
  speed = +speed.value;
  speedVal.textContent = speed;
};

count.oninput = () => {
  count = +count.value;
  countVal.textContent = count;
};

/* =========================
   HISTORY
========================= */
function log(msg){
  if (history.textContent.includes("No notifications"))
    history.innerHTML = "";
  history.innerHTML += "â€¢ " + msg + "<br>";
}

/* =========================
   NOTIFICATIONS (FIXED)
========================= */
function toast(title, body){
  const d = document.createElement("div");
  d.className = "toast";
  d.innerHTML = `<strong>${title}</strong><div>${body}</div>`;
  toastArea.appendChild(d);
  setTimeout(() => d.remove(), 3000);
}

/* ðŸ”‘ SINGLE PIPELINE â€” STATS ALWAYS UPDATE */
function send(title, body){
  incrementStat();

  if (isWindows || location.hostname.includes("github.io")) {
    toast(title, body);
  } else {
    try {
      new Notification(title, { body });
    } catch {
      toast(title, body);
    }
  }
}

/* =========================
   ACTIONS
========================= */
function requestPermission(){
  if ("Notification" in window)
    Notification.requestPermission();
}

function sendOne(){
  send(titleInput.value || "Demo",
       msgInput.value || "Hello");
  log(msgInput.value || "Hello");
}

function startDemo(){
  stopAll();
  bar.style.width = "0%";

  for (let i = 1; i <= count; i++) {
    const t = setTimeout(() => {
      send("SECURITY ALERT",
           msgInput.value || "Alert");
      bar.style.width = (i / count * 100) + "%";
      log("SECURITY ALERT");
    }, i * speed);
    timeouts.push(t);
  }
}

function stopAll(){
  while (timeouts.length)
    clearTimeout(timeouts.pop());
}
</script>
